---
export const prerender = false;
import Layout from "@/layouts/Layout.astro";
import { db } from "@/lib/core/db";

import { PageGuard } from "@/lib/ui/page-guard";

const { teamId } = Astro.params;

const guard = await PageGuard.protect(Astro, "team-member", { teamId });
if (guard) return guard;

const navData = Astro.locals.navData;
const user = navData?.context?.user;

const team = await db.team.findUnique({
    where: { id: teamId },
    include: {
        _count: {
            select: { members: true },
        },
    },
});

const member = await db.teamMember.findUnique({
    where: {
        userId_teamId: {
            userId: user?.id as string,
            teamId: teamId as string,
        },
    },
});

if (!team || !member) {
    return new Response(null, {
        status: 404,
        statusText: "Not Found",
    });
}
---

<Layout title={team.name} navData={navData}>
    <div class="flex flex-col gap-6 p-6" data-testid="team-dashboard-page">
        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold tracking-tight">{team.name}</h1>
        </div>
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
            <div
                class="rounded-xl border bg-card text-card-foreground shadow p-6"
            >
                <div
                    class="flex flex-row items-center justify-between space-y-0 pb-2"
                >
                    <h3 class="tracking-tight text-sm font-medium">
                        Total Members
                    </h3>
                </div>
                <div class="text-2xl font-bold">{team._count.members}</div>
            </div>
            <div
                class="rounded-xl border bg-card text-card-foreground shadow p-6"
            >
                <div
                    class="flex flex-row items-center justify-between space-y-0 pb-2"
                >
                    <h3 class="tracking-tight text-sm font-medium">
                        Your Role
                    </h3>
                </div>
                <div class="text-2xl font-bold">{member.role}</div>
            </div>
        </div>
    </div>
</Layout>
